<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset='utf-8' />
    <title>Календарь техосмотра</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

    <style>
        /* Basic styling for the calendar */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4; /* Light background */
        }

        #calendar {
            max-width: 1400px;
            margin: 50px auto;
            background-color: #fff; /* White container */
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 0px 0px rgba(0, 0, 0, 0.2); /* Shadow for depth */
        }

        .fc-header-toolbar {
            padding: 10px;
            text-align: center;
        }

        .fc-button {
            background-color: #007bff; /* Blue buttons */
            color: white;
            border: none;
            padding: 10px 15px; /* Larger buttons */
            border-radius: 4px;
            cursor: pointer;
            margin: 0 5px;
        }

        .fc-button:hover {
            background-color: #0056b3; /* Darker blue on hover */
        }

        .fc-event {
            background-color: #28a745; /* Green event color */
            border: none;
            padding: 4px 4px; /* Larger padding */
            margin: 1px;
            border-radius: 4px;
            font-size: 0.7em; /* Larger font size */
            text-align: center;
            text-transform: uppercase; /* Make text uppercase */
            font-style: italic; /* Make text italic */

            /* Flexbox for vertical and horizontal centering */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%; /* Ensures the event takes up the full height of its container */
        }

        .fc-event-time {
            font-style: italic;
        }

        .fc-event-title {
            font-weight: italic;
            color: #555;
        }

        /* Custom height and spacing for time grid cells */
        .fc-timegrid-slot {
            height: 100px !important; /* Increase the height of each time slot */
        }

        /* Ensure the calendar stays within the set time limits */
        .fc-timegrid-hour {
            height: 100px;
        }

        .fc-timegrid-slot-label {
            font-size: 14px;
        }

        /* Text in the slots */
        .fc-timegrid-slot div {
            font-size: 1em; /* Reduce text size by 30% */
            color: #555; /* Dark grey text */
        }
    </style>
</head>
<body>
    <div id='calendar'></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');

            if (!calendarEl) {
                console.error('Calendar element not found!');
                return;
            }

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek', // Show only weeks and days
                locale: 'ru',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'timeGridWeek,timeGridDay' // Remove dayGridMonth
                },
                editable: false,
                eventResizableFromStart: false,
                eventStartEditable: false,
                eventContent: function(arg) {
                    const eventData = arg.event.extendedProps;
                    const eventHtml = ` 
                        <b>${eventData.organization}</b><br>
                        ${eventData.name}<br>
                        ${eventData.vehicleType}<br>
                        ${eventData.carBrand || ''} ${eventData.carNumber || ''} 
                    `;
                    return { html: eventHtml };
                },
                events: function(fetchInfo, successCallback, failureCallback) {
                    console.log('Fetching events...');

                    fetch('https://teh-mir14.onrender.com/admin/bookings')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(bookings => {
                            console.log('Data from API:', bookings);

                            if (!bookings || !Array.isArray(bookings)) {
                                console.warn('API returned invalid data:', bookings);
                                return;
                            }

                            const events = bookings.map(booking => ({
                                id: booking._id,
                                title: `${booking.organization}, ${booking.name}`,
                                start: moment(booking.date + 'T' + booking.time).toISOString(),
                                end: moment(booking.date + 'T' + booking.time).add(1, 'hours').toISOString(),
                                allDay: false,
                                extendedProps: {
                                    organization: booking.organization,
                                    name: booking.name,
                                    vehicleType: booking.vehicleType,
                                    carBrand: booking.carBrand,
                                    carNumber: booking.carNumber
                                }
                            }));

                            console.log('Events to render:', events);
                            successCallback(events);
                        })
                        .catch(error => {
                            console.error('Error fetching events:', error);
                            failureCallback(error);
                        });
                },
                // Time grid settings
                slotDuration: '01:00:00', // Set the interval to 1 hour
                minTime: '08:00:00', // Start time 08:00
                maxTime: '20:00:00', // End time 20:00
                slotMinTime: '08:00:00', // Start time at 08:00
                slotMaxTime: '20:00:00', // End time at 20:00
                nowIndicator: true, // Show the current time indicator
                slotLabelInterval: '01:00:00', // Label interval for hours
                // Adjusting the cell height
                contentHeight: 'auto', // Dynamically adjust content height
                aspectRatio: 2, // Maintain proper aspect ratio
            });

            calendar.render();
        });
    </script>
</body>
</html>
